# Oton-Zzz クイックスタートガイド

## 🚀 最速セットアップ手順

### 準備完了チェック ✅

以下がすでに完了しています：
- ✅ `/boot/firmware/config.txt` にIR設定済み
- ✅ `/dev/lirc0` デバイスが存在
- ✅ `ir-ctl` コマンドが利用可能
- ✅ IR送信機能が動作確認済み

### 実行手順

#### 1. 仮想環境に入る
```bash
cd /home/hxs_jphacks/Oton-Zzz
source .venv/bin/activate
cd code/Oton_Zzz/Raspberry_Pi
```

#### 2. プログラムを実行
```bash
python3 main.py
```

これにより、以下の機能が同時に起動します：
- **睡眠検出システム**: カメラで寝落ちを監視
- **Webダッシュボード**: `http://localhost:5000` でアクセス可能
- **IRリモコン監視**: テレビのリモコン操作を監視

#### 3. リモコン登録（初回のみ）

初回起動時、ターミナルに以下のように表示されます：

```
⚠️  IR受信機能が利用できません
============================================================
このデバイスは送信専用のようです。

【手動登録モード】
M5StickCなどで事前に解析したNECコードを入力してください。
例: 0x20DF10EF

【TV】のNECコードを入力 (Enterでスキップ):
```

**ここで、M5StickC等で事前に解析したテレビのNECコードを入力してください。**

例:
```
0x20DF10EF
```

#### 4. 睡眠検出開始

登録が完了すると、自動的に睡眠検出が開始されます：

```
============================================================
Oton-Zzzシステムを開始します...
============================================================

✓ Oton-Zzzシステムが起動しました
  - Qキーで終了
  - 現在の状態: ACTIVE (睡眠検出中)
```

## 📡 動作フロー

1. **目を閉じる** → Sleep Gaugeが上昇
2. **約4秒間閉じ続ける** → Stage 1検出（警告モード）
   ```
   ⚠️  STAGE 1 DETECTED! 5秒後にOFF
   ```
   - 音声警告：「警告、5秒後にオフ」
   - LED：黄点滅
3. **さらに5秒間閉じ続ける** → Stage 2確定 → **テレビOFF！**
   ```
   😴 STAGE 2 CONFIRMED! 睡眠確定
   📡 テレビにIR信号を送信します...
   ```
   - 音声：「おやすみなさい」
   - LED：赤点灯（SLEEPモードへ移行）

## 📊 Webダッシュボード

ブラウザで `http://localhost:5000` にアクセスすると、ダッシュボードが表示されます。

- **今週のおやすみ回数**: 寝落ち検知回数
- **節約できた電気代**: 自動OFFによる節約額
- **週間レポート**: 日別の寝落ち回数グラフ
- **活動記録**: 詳細なログ（テレビON/OFF、寝落ち検知時刻など）

## 📂 関連ファイル

| パス | 説明 |
|---|---|
| `main.py` | システム全体のエントリーポイント |
| `src/core.py` | 睡眠検出・IR制御のコアロジック |
| `src/dashboard.py` | Webダッシュボード（Flaskアプリ） |
| `src/detector.py` | MediaPipeを使用した睡眠判定ロジック |
| `src/db.py` | データベース管理 |
| `config/ir_codes.json` | 登録されたIRコード |
| `data/oton_zzz.db` | 活動ログデータベース |

## 🔧 オプション機能

### ダッシュボードのみ起動
```bash
python3 main.py --dashboard-only
```

### システムテスト（一連の動作確認）
```bash
python3 main.py --test
```

## 🐛 トラブルシューティング

### Q: テレビをつけても検出が始まらない
**A**: リモコンの信号を正しく受信できていない可能性があります。IR受信機（GPIO18）が正しく接続されているか確認してください。また、テレビのリモコンをIR受信機に向けて操作してください。

### Q: 警告が出ずにいきなり切れる、または警告が出続ける
**A**: カメラの位置や照明を確認してください。顔が正しく認識されていない可能性があります。

### Q: データベースエラーが出る
**A**: `data` ディレクトリが存在し、書き込み権限があるか確認してください。

## 🎉 完成！

これで、目を閉じるとテレビの電源が自動的にOFFになり、その記録がダッシュボードで見られるシステムの完成です！

終了するには **Q** キーまたは **Ctrl+C** を押してください。
