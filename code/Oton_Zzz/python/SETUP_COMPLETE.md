# 🎉 IR送受信完全対応版 - セットアップ完了！

## ✅ 完了した修正内容

### 問題の原因
- `config.txt`に`dtoverlay=gpio-ir-rx`が設定されていましたが、ラズベリーパイ5には**`gpio-ir-rx.dtbo`ファイルが存在しません**
- 正しいoverlayは`gpio-ir`（受信専用）です

### 修正内容
1. **`/boot/firmware/config.txt`の修正**
   ```bash
   # 修正前
   dtoverlay=gpio-ir-rx,gpio_pin=18  ❌ (ファイルが存在しない)

   # 修正後
   dtoverlay=gpio-ir,gpio_pin=18     ✅ (正しいoverlay)
   ```

2. **IRデバイスの構成**
   - `/dev/lirc0` → **送信専用** (GPIO17)
   - `/dev/lirc1` → **受信専用** (GPIO18) ← 新たに作成！

3. **`ir_sleep_detector.py`の修正**
   - 送信と受信で別々のデバイスを使用するように変更
   - `/dev/lirc1`で受信、`/dev/lirc0`で送信

## 🚀 現在の状態

### 動作確認済み
- ✅ `/dev/lirc0` 送信デバイスが動作
- ✅ `/dev/lirc1` 受信デバイスが動作
- ✅ IR受信テスト成功（リモコン信号を正しく受信）
- ✅ IR送信テスト成功

### これからできること
- ✅ **リモコンを自動的に登録**（3回ボタンを押すだけ）
- ✅ **手動登録も可能**（M5StickCで解析したコードを入力）
- ✅ **Stage2で自動的にIR信号送信**

## 📝 使用方法

### 1. プログラム実行
```bash
cd /home/hxs_jphacks/Oton-Zzz
source .venv/bin/activate
cd code/Oton_Zzz/python
python3 ir_sleep_detector.py
```

### 2. リモコン登録（初回のみ）

#### 方法A: 自動登録（推奨）
プログラムが以下のように表示します：
```
============================================================
【TV】のリモコン信号を登録します
============================================================
リモコンのボタンを3回連続で押してください...
（各回5秒以内にボタンを押してください）

[1/3] リモコンボタンを押してください...
```

**ここで、テレビリモコンの電源ボタンをIR受信機（GPIO18）に向けて3回押してください**

成功すると：
```
[1/3] リモコンボタンを押してください... ✓ 受信成功
[2/3] リモコンボタンを押してください... ✓ 受信成功
[3/3] リモコンボタンを押してください... ✓ 受信成功

✓ 【TV】のリモコン信号を登録しました！
```

#### 方法B: 手動登録（受信がうまくいかない場合）
受信に失敗した場合、手動登録モードが起動します：
```
⚠️  IR受信機能が利用できません
============================================================
【手動登録モード】
M5StickCなどで事前に解析したNECコードを入力してください。
例: 0x20DF10EF

【TV】のNECコードを入力 (Enterでスキップ):
```

M5StickCで解析したNECコードを入力してください。

### 3. 睡眠検出の開始

登録が完了すると、自動的に睡眠検出が開始されます：
```
============================================================
睡眠検出を開始します...
============================================================

✓ 睡眠検出システムが起動しました
  - Qキーで終了
```

### 4. 動作確認

1. **カメラに顔を映す**
2. **目を閉じる** → Sleep Gaugeが上昇
3. **約4秒間閉じ続ける** → Stage 1検出
   ```
   ⚠️  STAGE 1 DETECTED! 睡眠の可能性...
   ```
4. **さらに3秒間閉じ続ける** → Stage 2確定 → **IR信号送信！**
   ```
   😴 STAGE 2 CONFIRMED! 睡眠確定
   📡 テレビにIR信号を送信します...
   📡 【TV】にIR信号を送信中... ✓ 送信完了
   ```

## 🔧 再起動後の設定

現在、`sudo dtoverlay gpio-ir gpio_pin=18`で手動で受信デバイスをロードしました。
**再起動すると`config.txt`の設定が自動的に適用されます**。

確認コマンド：
```bash
# 再起動後、デバイスが存在するか確認
ls -la /dev/lirc*

# 以下が表示されればOK
# /dev/lirc0 (送信)
# /dev/lirc1 (受信)
```

## 📂 テストツール

### IR受信テスト（lirc1）
```bash
python3 test_ir_receive_lirc1.py
```
リモコンボタンを押して、受信できるかテスト

### IR送信テスト
```bash
python3 test_ir_send.py 0x20DF10EF
```
指定したNECコードを送信してテスト

## 🎯 完成！

これで、**送受信機能が完全に動作します**。

- ✅ IR受信でリモコン信号を自動登録
- ✅ 手動登録も可能
- ✅ `main.py`の目を閉じる検出ロジックをそのまま実装
- ✅ Stage2で自動的にテレビの電源をOFF

## 📚 トラブルシューティング

### 再起動後に`/dev/lirc1`が作成されない場合

`/boot/firmware/config.txt`を確認：
```bash
grep gpio-ir /boot/firmware/config.txt
```

以下のように表示されればOK：
```
dtoverlay=gpio-ir-tx,gpio_pin=17
dtoverlay=gpio-ir,gpio_pin=18
```

### リモコン信号が受信できない場合

1. IR受信機の配線を確認（GPIO18、GND、VCC）
2. リモコンをIR受信機に近づける（5〜10cm）
3. 別のボタンを試す
4. 手動登録モードを使用

### テレビが反応しない場合

1. IR送信機の配線を確認（GPIO17、GND、VCC）
2. IR LEDの極性を確認（長い方が+）
3. テストツールで送信テスト：
   ```bash
   python3 test_ir_send.py
   ```
4. 別のNECコードを登録

---

**何か問題があれば、お気軽にお聞きください！**
